<!-- user row -->
<div class = "row-fluid">

    <div class= "span2" id="user-pic">
      <p>
        <%= image_tag avatar_url(@user), :size =>"85x90"%>
      </p>
    </div>

    <div class="span3" id="user-name">
        <p class="lead" id="name-text">
          <h4><%= @user.name %></h4>
        </p>
        <p>
         <!-- Joined: <%= @user.created_at.month %>-<%= @user.created_at.day %>-<%= @user.created_at.year %>
          <br>-->
          Location of solar panel: <%= @location %>
        </p>
    </div>

    <div id="weather">
      <%= @location %>
      <%= @weather %>
    </div>

</div>

  <!-- chart and highlight row -->
<div class="row-fluid">

      <div class="span3">
        <table id="sidebar-graph">
          <tr id="sun-hl" rel="tooltip" title="kWh is the unit of measurement for electricity. Your panel is responsible for <%= number_to_human(@user.calculate_overall_power_for, :precision =>2, :units => {:unit => 'Wh', :thousand => 'kWh', :million => 'MWh'}) %> of renewable energy over the duration of its operation.">
            <td><h1><%= number_to_human(@user.calculate_overall_power_for, :precision =>2, :units => {:unit => 'Wh', :thousand => 'kWh', :million => 'MWh'}) %></h1></td>
          </tr>
          <tr id="dollar-hl" rel="tooltip" title="The clean energy produced by your panel is being sold to a local utility and has generated $<%= number_to_human(@user.calculate_overall_money_for, :precision => 2) %> for you.">
            <td><h1>$<%= number_to_human(@user.calculate_overall_money_for, :precision => 2) %></h1></td>
          </tr>
          <tr id="green-hl" rel="tooltip" title="The dirty energy replaced by your panel is equivalent to planting <%= number_to_human(@user.calculate_overall_trees_for, :precision => 0, :units => {:unit => 'tree', :ten => 'trees'}) %>.">
            <td><h1><%= number_to_human(@user.calculate_overall_trees_for, :precision => 0, :units => {:unit => 'tree', :ten => 'trees'}) %></h1></td>
          </tr>
        </table>
      </div>

      <div id="range-buttons" class="span8 hidden-phone">
        <div class="graph-title"><p class="lead">Clean energy produced by your solar panel (Wh)</p></div>
        <p>
          <div class="btn-group  pull-right" data-toggle="buttons-radio">
            <button type="button" class="btn" id="day">Day</button>
            <button type="button" class="btn" id="week" >Week</button>
            <button type="button" class="btn" id="year">Year</button>
          </div>
        </p>
        <p>
          <div id="year-graph", style="width:700px;height:387px"></div>
        </p>
      </div>

  </div>

<!-- Table for all metrics

      <div class="btn-group btn-group-vertical">
        <button class= "btn btn-block" id="perf">Performance</button>
        <button class= "btn btn-block" id="finance">Finance</button>
        <button class= "btn btn-block" id="green">Environment</button>
      </div>

<div class="row-fluid">
  <div class="span6 offset2">
    <p>
      <h2>Cumulative metrics</h2>
      <table class="table table-striped">
        <tr>
          <th>Clean energy produced</th>
          <td><%= number_with_precision(@user.calculate_overall_power_for, :precision =>2) %> Wh</td>
        </tr>
        <tr>
          <th>Money accrued</th>
          <td><%= number_with_precision(@user.calculate_overall_money_for, :precision =>2) %> dollars </td>
        </tr>
        <tr>
          <th>Equivalent emissions captured</th>
          <td><%= number_with_precision(@user.calculate_overall_emissions_for, :precision =>2) %> kg </td>
        </tr>
        <tr>
          <th>Equivalent trees planted</th>
          <td><%= number_with_precision(@user.calculate_overall_trees_for, :precision =>2) %> trees</td>
        </tr>
        <tr>
          <th>Equivalent cars taken off the road</th>
          <td><%= number_with_precision(@user.calculate_overall_cars_for, :precision =>2) %> cars</td>
        </tr>
      </table>
    </p>
-->

<!--    <p>
    	<% if @user.energy_data.any? %>
          <h2> Last 10 energy-producing hours </h2>
          <table class="table table-striped">
            <tr>
              <th>Day</th>
              <th>Solar output</th>
              <th>Emissions saved</th>
              <th>Fraction of a tree planted</th>
              <th>Money accrued</th>
            </tr>
                <%= render :partial => 'energy_data/energy_datum.html.erb', :collection => @energy_data, :as => :energy %>
          </table>
        <% end %>
    </p> -->


<% javascript_tag do %>
 
<% end %>

<script type="text/javascript">
$(document).ready(
$(function () {

                  //alert((new Date()).getTime());

    var exValue = 1;
    var sideGraphStat = $("#sidebar-graph");
    var sideGraphTD = $("#sample")

     var xyData = <%= @monthTotals.to_json %>;
     var chartLabel = "Solar output (Wh)";
     var weekXY = <%= @weekTotals.to_json %>;
     var dayXY = <%= @dayTotals.to_json %>;

     var placeholder = $("#year-graph");
     var data = xyData;
     var options = {
          //lines: {show:true},
          points: {show:false},
          bars: {show:true,
            align: "center",
            barWidth: 21*(24 * 60 * 60 * 1000)}, //#*day
          xaxis: {
          mode: "time",
          timeformat: "%b",
          monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
          },
          grid: {hoverable:true, 
                clickable:true, 
                autohighlight:true}
          //timeformat: "%H %p",
          //twelveHourClock: true}
        };


      $('#sun-hl').tooltip();
      $('#dollar-hl').tooltip();
      $('#green-hl').tooltip();

      $('#day').click(function(){
        data = switchProf(0);
        options = {
          bars: {show:true,
            align: "center",
            barWidth: 0.03*(24 * 60 * 60 * 1000)},
          xaxis: {
          mode: "time",
          //timeformat: "%m"
          //timeformat: "%H %p",
          twelveHourClock: true},
          grid: {hoverable:true, 
                clickable:true, 
                autohighlight:true}
        };

        doThis();
      });

      $('#week').click(function(){
        data = switchProf(1);
        options = {
          bars: {show:true,
            align: "center",
            barWidth: 0.8*(24 * 60 * 60 * 1000)},
          xaxis: {
          mode: "time",
          //timeformat: "%m"
          timeformat: "%b %d",
          dayNames: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
          //twelveHourClock: true}
          },
          grid: {hoverable:true, 
                clickable:true, 
                autohighlight:true}
        };
        doThis();
      });

      $('#year').click(function(){
        data = switchProf(2);
        options = {
          bars: {show:true,
            align: "center",
            barWidth: 21*(24 * 60 * 60 * 1000)},
          xaxis: {
          mode: "time",
          timeformat: "%b",
          monthNames: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
          //timeformat: "%H %p",
          //twelveHourClock: true}
          },
          grid: {hoverable:true, 
                  clickable:true, 
                  autohighlight:true}
        };
        doThis();
      });


  function switchProf(timeGran) {
    var dataReturn = [];
      switch (timeGran) {
        case 0:    //day
          dataReturn = <%= @dayTotals.to_json %>
          break;
        case 1:    //month
          dataReturn = <%= @weekTotals.to_json %>
          break;
        case 2:    //year
          dataReturn = <%= @monthTotals.to_json %>
          break;
      }

    return dataReturn;
  }

//redraws canvas
  function doThis() {
     $.plot(placeholder,[data], options).draw();
  } 

  //event listeners

      function showTooltip(x, y, contents) {
        $('<div id="tooltip">' + contents + '</div>').css( {
            position: 'absolute',
            display: 'none',
            top: y - 30,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#fee',
            opacity: 0.80
        }).appendTo("body").fadeIn(200);
    }

    //var previousPoint = null;
      placeholder.bind("plothover", function (event, pos, item) {
         // alert('check');
       // if ($("#enableTooltip:checked").length > 0) {
            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;
                    
                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
                    
                    showTooltip(item.pageX, item.pageY,
                                y + " Wh");
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;            
            }
        //}
    });

    placeholder.bind("plotclick", function(event, pos, item) {
      //alert('woo');
    })

  doThis();
}));
</script>